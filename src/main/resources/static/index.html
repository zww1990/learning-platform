<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
		<title>hello</title>
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		<link href="roboto/css.css" rel="stylesheet">
		<link href="font/css/materialdesignicons.min.css" rel="stylesheet">
		<link href="vuetify/vuetify.min.css" rel="stylesheet">
	</head>
	<body>
		<div id="app">
			<v-app>
			  <v-main>
				<v-container>
				  <v-row>
					  <v-col>
					  	<v-btn color="primary" @click="addRow()">添加员工</v-btn>
					  	<v-btn color="primary" @click="open()">添加地址</v-btn>
					  </v-col>
				  </v-row>
				  <v-row>
					  <v-col>
						  <v-simple-table>
						    <template v-slot:default>
						      <thead>
						        <tr>
						          <th class="text-left" style="width: 100px;">员工编号</th>
						          <th class="text-left" style="width: 100px;">员工姓名</th>
						          <th class="text-left" style="width: 100px;">员工密码</th>
						          <th class="text-left" style="width: 300px;">公司地址</th>
						          <th class="text-left" style="width: 150px;">上班时间</th>
						          <th class="text-left" style="width: 100px;">上班状态</th>
						          <th class="text-left" style="width: 150px;">下班时间</th>
						          <th class="text-left" style="width: 100px;">下班状态</th>
						          <th class="text-left" style="width: 200px;">操作</th>
						        </tr>
						      </thead>
						      <tbody>
						        <tr v-for="(user, index) in users" :key="index">
						          <td>
						          	<v-text-field 
							          	label="员工编号" 
							          	placeholder="员工编号" 
							          	v-model="user.userNo" 
							          	v-if="user.edited"
							          	clearable>
						          	</v-text-field>
						          	<span v-else-if="user.status === 1">
						          		<a @click="showList(user)">{{ user.userNo }}</a>
						          	</span>
						          	<span v-else>{{ user.userNo }}</span>
						          </td>
						          <td>
						          	<v-text-field 
							          	label="员工姓名" 
							          	placeholder="员工姓名" 
							          	v-model="user.username" 
							          	v-if="user.edited"
							          	clearable>
						          	</v-text-field>
						          	<span v-else>{{ user.username }}</span>
						          </td>
						          <td>
						          	<v-text-field 
							          	label="员工密码" 
							          	placeholder="员工密码" 
							          	v-model="user.password" 
							          	v-if="user.edited"
							          	clearable>
						          	</v-text-field>
						          	<span v-else>******</span>
						          </td>
						          <td>
						              <v-select 
							              v-model="user.addr" 
							              :items="addresses" 
							              item-text="address" 
							              item-value="id" 
							              return-object>
						              </v-select>
						          </td>
						          <td>{{user?.staffClock?.clockTimeMin}}</td>
						          <td>{{user?.staffClock?.clockWorkOnStatusName}}</td>
						          <td>{{user?.staffClock?.clockTimeMax}}</td>
						          <td>{{user?.staffClock?.clockWorkOffStatusName}}</td>
						          <td>
						          	<v-btn color="success" @click="gotoWork(user)" v-if="user.status === 1">打卡</v-btn>
						          	<v-alert type="error" v-else>{{user.message}}</v-alert>
						          </td>
						        </tr>
						      </tbody>
						    </template>
						  </v-simple-table>
					  </v-col>
		          </v-row>
			      <v-dialog transition="dialog-bottom-transition" v-model="dialog">
			          <v-card>
			            <v-toolbar color="purple">
			            	{{user?.username}}打卡记录{{logList?.length}}条
			            	<v-spacer></v-spacer>
			            	<v-btn icon @click="dialog = false">
			            		<v-icon>mdi-close</v-icon>
			            	</v-btn>
			            </v-toolbar>
			            <v-card-text>
						  <v-simple-table dense fixed-header height="500px">
						    <template v-slot:default>
						      <thead>
						        <tr>
						          <th class="text-left">主键</th>
						          <th class="text-left">员工编号</th>
						          <th class="text-left">打卡时间</th>
						          <th class="text-left">经度</th>
						          <th class="text-left">纬度</th>
						          <th class="text-left">打卡地址</th>
						          <th class="text-left">打卡类型</th>
						          <th class="text-left">创建时间</th>
						        </tr>
						      </thead>
						      <tbody>
						        <tr v-for="(log, index) in logList" :key="index">
						          <td>{{log.id}}</td>
						          <td>{{log.staff_no}}</td>
						          <td>{{log.clock_time}}</td>
						          <td>{{log.longitude}}</td>
						          <td>{{log.latitude}}</td>
						          <td>{{log.address}}</td>
						          <td>{{log.clock_type === 0 ? 'OA打卡' : '审批补卡'}}</td>
						          <td>{{log.create_time}}</td>
						        </tr>
						      </tbody>
						    </template>
						  </v-simple-table>
			            </v-card-text>
			          </v-card>
			      </v-dialog>
				    <v-dialog v-model="addrDialog" persistent max-width="400px" transition="dialog-top-transition">
				      <v-card>
				      	<v-form ref="form" lazy-validation>
					        <v-toolbar color="purple">
					          <span class="text-h5">公司地址</span>
					        </v-toolbar>
					        <v-card-text>
					          <v-container>
					            <v-row>
					              <v-col cols="12">
					                <v-text-field 
						                label="经度*" 
						                required 
						                v-model="addr.longitude" 
						                :rules="validation.longitudeRules"
						                clearable
						                type="number"
						                min="0">
					                </v-text-field>
					              </v-col>
					              <v-col cols="12">
					                <v-text-field 
						                label="纬度*" 
						                required 
						                v-model="addr.latitude" 
						                :rules="validation.latitudeRules"
						                clearable
						                type="number"
						                min="0">
					                </v-text-field>
					              </v-col>
					              <v-col cols="12">
					                <v-text-field 
						                label="地址*" 
						                required 
						                v-model="addr.address" 
						                :rules="validation.addressRules"
						                clearable>
					                </v-text-field>
					              </v-col>
					            </v-row>
					          </v-container>
					        </v-card-text>
					        <v-card-actions>
					          <v-spacer></v-spacer>
					          <v-btn color="green darken-1" text @click="close()">关闭</v-btn>
					          <v-btn color="green darken-1" text @click="save()">保存</v-btn>
					        </v-card-actions>
				        </v-form>
				      </v-card>
				    </v-dialog>
				</v-container>
			  </v-main>
			</v-app>
		</div>
	</body>
	<script src="vue/vue.min.js"></script>
	<script src="vuetify/vuetify.min.js"></script>
	<script src="vuetify-toast-snackbar-ng/index.umd.min.js"></script>
	<script type="text/javascript">
		new Vue({
			el:'#app',
			vuetify: new Vuetify({
				theme: { dark: true },
			}),
			data:{
				users: [],
				user: null,
				addresses: [],
				addr: {
					id: null,
					address: null,
					longitude: null,
					latitude: null,
				},
				validation: {
					longitudeRules: [v => !!v || '经度必须填'],
					latitudeRules: [v => !!v || '纬度必须填'],
					addressRules: [v => !!v || '地址必须填'],
				},
				logList: [],
				dialog: false,
				addrDialog: false,
			},
			async mounted(){
				let json1 = await (await fetch('/hello/addresses')).json();
				this.addresses = json1.data;
				let json2 = await (await fetch('/hello/users')).json();
				this.users = json2.data;
				let addr = this.addresses[0];
				this.users.forEach(user => {
					fetch('/hello/initStaffClock',{
						  method: 'POST',
						  body: JSON.stringify({...user, ...addr}),
						  headers: new Headers({'Content-Type': 'application/json'})
					})
					.then(res => res.json())
					.then(res => {
						user.status = res.status;
						user.message = res.message;
						user.staffClock = res.data;
						user.addr = addr;
					});
				});
			},
			methods: {
				gotoWork(user){
				  if (user.userNo === null || user.userNo.length === 0) {
					this.$toast.error('请输入员工编号', {x: 'center', y: 'top'});
			        return;
			      }
			      if (user.username === null || user.username.length === 0) {
					this.$toast.error('请输入员工姓名', {x: 'center', y: 'top'});
			        return;
			      }
			      if (user.password === null || user.password.length === 0) {
					this.$toast.error('请输入员工密码', {x: 'center', y: 'top'});
			        return;
			      }
					fetch('/hello/userLoginAndStaffClock', {
						  method: 'POST',
						  body: JSON.stringify({...user, ...user.addr}),
						  headers: new Headers({'Content-Type': 'application/json'})
					})
					.then(res => res.json())
					.then(res => {
						user.status = res.status;
						user.message = res.message;
						user.staffClock = res.data;
						user.edited = user.status === 0;
					});
				},
				addRow(){
					this.users.push({
						userNo: null, 
						password: null, 
						username: null, 
						addr: this.addresses[0], 
						status: 1, 
						edited: true,
						staffClock: null
					});
				},
				open(){
					this.addrDialog = true;
				},
				close(){
					this.addrDialog = false;
			        this.$refs.form.reset();
				},
				save() {
					if(this.$refs.form.validate()){
						this.addr.id = this.addresses.length + 1;
						fetch('/hello/saveaddress',{
							  method: 'POST',
							  body: JSON.stringify(this.addr),
							  headers: new Headers({'Content-Type': 'application/json'})
						})
						.then(res => res.json())
						.then(res => {
							console.log(res);
						});
						this.addresses.push({...this.addr});
						this.close();
					}
		        },
				showList(user){
					fetch('/hello/selectAppStaffClockLogList',{
						  method: 'POST',
						  body: JSON.stringify(user),
						  headers: new Headers({'Content-Type': 'application/json'})
					})
					.then(res => res.json())
					.then(res => {
						this.logList = res.data || [];
						this.user = user;
						this.dialog = true;
					});
				}
		    }
		})
	</script>
</html>
